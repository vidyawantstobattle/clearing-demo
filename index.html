<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clearing Demo</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #fff7f2;
      margin: 0;
      padding: 0;
      text-align: center;
      color: #333;
    }
    h1, h2, h3 { color: #FF6200; }
    .container {
      max-width: 420px;
      margin: auto;
      padding: 20px;
    }
    input, select, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 12px;
      border: 1px solid #ddd;
      font-size: 16px;
    }
    button {
      background-color: #FF6200;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
    }
    button:hover {
      background-color: #e15700;
    }
    .btn-gray {
      background-color: #ccc;
      color: #333;
    }
    .card {
      background: white;
      padding: 10px;
      margin: 8px 0;
      border-radius: 12px;
      border-left: 5px solid #FF6200;
      text-align: left;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .badge {
      display: inline-block;
      background: #ffd7bf;
      color: #FF6200;
      border-radius: 20px;
      padding: 6px 12px;
      margin: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
    }
    .badge.selected {
      background: #FF6200;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Clearing Simulation</h1>
    <div id="app"></div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCewxnuNzlIe9MydL-ozj7URdk2yEvb_kU",
      authDomain: "clearing-demo.firebaseapp.com",
      projectId: "clearing-demo",
      storageBucket: "clearing-demo.firebasestorage.app",
      messagingSenderId: "21071168079",
      appId: "1:21071168079:web:4471b13152955dbde6a03a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let player = null;
    let players = [];
    let expenses = [];
    let stage = "login";
    let simplified = [];

    const appDiv = document.getElementById("app");

    const render = () => {
      if (stage === "login") {
        appDiv.innerHTML = `
          <h3>Enter your name to join</h3>
          <input id="nameInput" placeholder="Your name" />
          <input id="codeInput" placeholder="(Admin code optional)" />
          <button id="joinBtn">Join</button>
        `;
        document.getElementById("joinBtn").onclick = async () => {
          const name = document.getElementById("nameInput").value.trim();
          const code = document.getElementById("codeInput").value.trim();
          if (!name) return alert("Please enter a name");

          const snapshot = await getDocs(collection(db, "players"));
          const playerCount = snapshot.size;

          const isAdmin = code === "13579" || playerCount === 0;
          const playerName = isAdmin ? "Vidya" : name;

          const ref = await addDoc(collection(db, "players"), {
            name: playerName,
            isAdmin
          });
          player = { id: ref.id, name: playerName, isAdmin };
          stage = "waiting";
          render();
        };
      }

      else if (stage === "waiting") {
        appDiv.innerHTML = `
          <h3>Waiting for others to join...</h3>
          <div style="margin: 10px 0;">
            ${players.map(p => `<span class="badge">${p.name}</span>`).join(" ")}
          </div>
          ${player.isAdmin ? `<button id="continueBtn">Continue</button>` : ""}
        `;
        if (player.isAdmin) {
          document.getElementById("continueBtn").onclick = async () => {
            await setDoc(doc(db, "stage", "state"), { value: "expenses" });
          };
        }
      }

      else if (stage === "expenses") {
        appDiv.innerHTML = `
          <h3>Add an Expense</h3>
          <select id="payerSelect">
            ${players.map(p => `<option value="${p.id}">${p.name}</option>`).join("")}
          </select>
          <input id="amountInput" type="number" placeholder="Amount (1â€“1000)" min="1" max="1000" />
          <div id="payeesContainer">
            ${players.map(p => `<span class="badge" data-id="${p.id}">${p.name}</span>`).join("")}
          </div>
          <button id="addExpenseBtn">Add Expense</button>
          <div>Total Expenses: ${expenses.length}</div>
          ${player.isAdmin ? `<button id="continueBtn">Continue to Debts</button>` : ""}
        `;

        // Badge click toggle
        document.querySelectorAll(".badge").forEach(badge => {
          badge.onclick = () => badge.classList.toggle("selected");
        });

        document.getElementById("addExpenseBtn").onclick = async () => {
          const payer = document.getElementById("payerSelect").value;
          const amount = parseInt(document.getElementById("amountInput").value);
          const payees = Array.from(document.querySelectorAll(".badge.selected")).map(b => b.dataset.id);
          if (!payer || !amount || amount < 1 || amount > 1000 || payees.length < 2) {
            alert("Enter valid amount (1â€“1000) and select 2+ payees");
            return;
          }
          await addDoc(collection(db, "expenses"), { payer, amount, payees });
        };
        if (player.isAdmin) {
          document.getElementById("continueBtn").onclick = async () => {
            await setDoc(doc(db, "stage", "state"), { value: "debts" });
          };
        }
      }

      else if (stage === "debts") {
        const findName = (idOrName) => {
          const p = players.find(p => p.id === idOrName || p.name === idOrName);
          return p ? p.name : idOrName;
        };

        const beforeList = expenses.map(
          (e) => `${findName(e.payer)} paid â‚¬${e.amount} for [${e.payees.map(findName).join(", ")}]`
        );

        appDiv.innerHTML = `
          <h3>Debts</h3>
          <div id="debtsDisplay" data-mode="raw">
            ${beforeList.map(x => `<div class="card">${x}</div>`).join("")}
          </div>
          ${player.isAdmin ? `
            <div style="margin-top:20px;">
              <button id="toggleSimplify">Toggle Simplify View</button>
              <button class="btn-gray" id="resetBtn">Reset</button>
              <button class="btn-gray" id="startOverBtn">Start Over</button>
            </div>` : ""}
        `;

        if (player.isAdmin) {
          document.getElementById("toggleSimplify").onclick = () => {
            if (simplified.length === 0) simplify();
            else toggleView();
          };
          document.getElementById("resetBtn").onclick = resetExpenses;
          document.getElementById("startOverBtn").onclick = startOver;
        }
      }
    };

    // ðŸ” Firebase listeners
    onSnapshot(collection(db, "players"), (snap) => {
      players = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      if (stage === "waiting") render();
    });
    onSnapshot(collection(db, "expenses"), (snap) => {
      expenses = snap.docs.map(d => d.data());
      if (stage === "expenses") render();
    });
    onSnapshot(doc(db, "stage", "state"), (docSnap) => {
      if (docSnap.exists()) {
        stage = docSnap.data().value;
        if (stage === "debts") simplify();
        render();
      }
    });

    // ðŸ§® Simplify debts
    function simplify() {
      const balance = {};
      expenses.forEach(e => {
        const per = e.amount / e.payees.length;
        e.payees.forEach(p => balance[p] = (balance[p] || 0) - per);
        balance[e.payer] = (balance[e.payer] || 0) + e.amount;
      });

      const creditors = [], debtors = [];
      for (const [id, amt] of Object.entries(balance)) {
        if (amt > 0.5) creditors.push({ id, amt });
        else if (amt < -0.5) debtors.push({ id, amt: -amt });
      }
      simplified = [];
      while (creditors.length && debtors.length) {
        const c = creditors[0], d = debtors[0];
        const pay = Math.min(c.amt, d.amt);
        simplified.push(`${findName(d.id)} â†’ ${findName(c.id)}: â‚¬${pay.toFixed(2)}`);
        c.amt -= pay; d.amt -= pay;
        if (c.amt < 0.5) creditors.shift();
        if (d.amt < 0.5) debtors.shift();
      }
    }

    function toggleView() {
      const div = document.getElementById("debtsDisplay");
      if (!div) return;
      if (div.dataset.mode === "raw") {
        div.innerHTML = simplified.map(x => `<div class="card">${x}</div>`).join("");
        div.dataset.mode = "simple";
      } else {
        div.innerHTML = expenses.map(
          e => `<div class="card">${findName(e.payer)} paid â‚¬${e.amount} for [${e.payees.map(findName).join(", ")}]</div>`
        ).join("");
        div.dataset.mode = "raw";
      }
    }

    async function resetExpenses() {
      const snaps = await getDocs(collection(db, "expenses"));
      snaps.forEach(async s => await deleteDoc(s.ref));
      await setDoc(doc(db, "stage", "state"), { value: "expenses" });
    }

    async function startOver() {
      const playersSnap = await getDocs(collection(db, "players"));
      playersSnap.forEach(async s => await deleteDoc(s.ref));
      const expensesSnap = await getDocs(collection(db, "expenses"));
      expensesSnap.forEach(async s => await deleteDoc(s.ref));
      await setDoc(doc(db, "stage", "state"), { value: "login" });
      location.reload();
    }

    function findName(idOrName) {
      const p = players.find(p => p.id === idOrName || p.name === idOrName);
      return p ? p.name : idOrName;
    }

    render();
  </script>
</body>
</html>
