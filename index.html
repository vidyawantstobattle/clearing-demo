<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clearing Demo</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #fff6f0;
      color: #333;
      text-align: center;
    }
    .btn {
      background: #FF6200;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 8px;
      font-size: 16px;
    }
    .btn-gray {
      background: #999;
    }
    input, select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin: 5px;
      width: 80%;
      max-width: 300px;
    }
    .payee-btn {
      border: 1px solid #FF6200;
      border-radius: 20px;
      padding: 5px 10px;
      margin: 4px;
      cursor: pointer;
      display: inline-block;
    }
    .selected {
      background: #FF6200;
      color: white;
    }
  </style>
</head>
<body>
  <h1 style="color:#FF6200">Clearing Demo</h1>
  <div id="app">Loading...</div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc,
      doc, setDoc, onSnapshot, serverTimestamp, getDoc
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCewxnuNzlIe9MydL-ozj7URdk2yEvb_kU",
      authDomain: "clearing-demo.firebaseapp.com",
      projectId: "clearing-demo",
      storageBucket: "clearing-demo.firebasestorage.app",
      messagingSenderId: "21071168079",
      appId: "1:21071168079:web:4471b13152955dbde6a03a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let player = JSON.parse(localStorage.getItem("player"));
    let stage = "login";
    let players = [];
    let expenses = [];
    let simplified = [];

    const appDiv = document.getElementById("app");

    async function init() {
      const stRef = doc(db, "state", "game");
      const snap = await getDoc(stRef);
      if (!snap.exists()) await setDoc(stRef, { stage: "login" });

      onSnapshot(collection(db, "players"), (s) => {
        players = s.docs.map(d => ({ id: d.id, ...d.data() }));
        render();
      });
      onSnapshot(collection(db, "expenses"), (s) => {
        expenses = s.docs.map(d => ({ id: d.id, ...d.data() }));
      });
      onSnapshot(stRef, (s) => {
        if (s.exists()) {
          stage = s.data().stage;
          render();
        }
      });
      render();
    }

    async function handleLogin() {
      const name = document.getElementById("name").value.trim() || "Anonymous";
      const code = document.getElementById("code").value.trim();
      const isAdmin = code === "13579";
      const finalName = isAdmin ? "Vidya" : name;
      const pRef = await addDoc(collection(db, "players"), {
        name: finalName,
        isAdmin,
        joinedAt: serverTimestamp()
      });
      player = { id: pRef.id, name: finalName, isAdmin };
      localStorage.setItem("player", JSON.stringify(player));
      render();
    }

    async function nextStage() {
      const stRef = doc(db, "state", "game");
      if (stage === "login") await setDoc(stRef, { stage: "expenses" });
      else if (stage === "expenses") await setDoc(stRef, { stage: "debts" });
    }

    async function resetAll() {
      const pSnap = await getDocs(collection(db, "players"));
      for (const d of pSnap.docs) await deleteDoc(d.ref);
      const eSnap = await getDocs(collection(db, "expenses"));
      for (const d of eSnap.docs) await deleteDoc(d.ref);
      await setDoc(doc(db, "state", "game"), { stage: "login" });
      localStorage.removeItem("player");
      player = null;
      render();
    }

    async function addExpense() {
      const payer = document.getElementById("payer").value;
      const amount = parseInt(document.getElementById("amount").value);
      const selected = [...document.querySelectorAll(".payee-btn.selected")].map(b => b.dataset.name);
      if (!payer || selected.length < 2 || isNaN(amount)) return alert("Please fill all fields.");
      if (amount < 1 || amount > 1000) return alert("Amount must be between 1 and 1000.");
      await addDoc(collection(db, "expenses"), { payer, payees: selected, amount });
      document.getElementById("amount").value = "";
      selected.forEach(n => document.querySelector(`[data-name='${n}']`).classList.remove("selected"));
      render();
    }

    function simplify() {
      const balance = {};
      expenses.forEach(e => {
        const share = e.amount / e.payees.length;
        e.payees.forEach(p => {
          if (p === e.payer) return;
          balance[p] = (balance[p] || 0) - share;
          balance[e.payer] = (balance[e.payer] || 0) + share;
        });
      });
      const creditors = [], debtors = [];
      for (const [n, v] of Object.entries(balance)) {
        if (v > 0) creditors.push({ n, v });
        else if (v < 0) debtors.push({ n, v: -v });
      }
      const result = [];
      let i = 0, j = 0;
      while (i < debtors.length && j < creditors.length) {
        const pay = Math.min(debtors[i].v, creditors[j].v);
        result.push(`${debtors[i].n} → ${creditors[j].n}: €${Math.round(pay)}`);
        debtors[i].v -= pay; creditors[j].v -= pay;
        if (debtors[i].v === 0) i++;
        if (creditors[j].v === 0) j++;
      }
      simplified = result;
      render();
    }

    function render() {
      if (!player) {
        appDiv.innerHTML = `
          <input id="name" placeholder="Enter your name" /><br>
          <input id="code" placeholder="Admin code (optional)" type="password" /><br>
          <button class="btn" onclick="handleLogin()">Join Game</button>
        `;
        return;
      }

      if (stage === "login") {
        appDiv.innerHTML = `
          <h3>Waiting Room</h3>
          <p>Players joined: ${players.length}</p>
          <ul style="list-style:none;padding:0;">${players.map(p=>`<li>${p.name}</li>`).join("")}</ul>
          ${player.isAdmin ? `<button class="btn" onclick="nextStage()">Continue</button>` : ""}
        `;
        return;
      }

      if (stage === "expenses") {
        appDiv.innerHTML = `
          <h3>Add Expense</h3>
          <select id="payer">
            <option value="">Select payer</option>
            ${players.map(p=>`<option>${p.name}</option>`).join("")}
          </select><br>
          <div>Select payees:</div>
          <div>${players.map(p=>`<span class="payee-btn" data-name="${p.name}" onclick="this.classList.toggle('selected')">${p.name}</span>`).join("")}</div>
          <input id="amount" type="number" placeholder="Amount (1-1000)" /><br>
          <button class="btn" onclick="addExpense()">Submit</button>
          <p>Total expenses: ${expenses.length}</p>
          ${player.isAdmin ? `<button class="btn" onclick="nextStage()">Continue</button>` : ""}
        `;
        return;
      }

      if (stage === "debts") {
        appDiv.innerHTML = `
          <h3>Debts</h3>
          ${simplified.length ? simplified.map(x=>`<div>${x}</div>`).join("") :
          expenses.map(e=>`<div>${e.payer} paid €${e.amount} for [${e.payees.join(", ")}]</div>`).join("")}
          ${player.isAdmin ? `
            <div style="margin-top:20px;">
              <button class="btn" onclick="simplify()">Simplify Debts</button>
              <button class="btn btn-gray" onclick="resetAll()">Reset</button>
            </div>` : ""}
        `;
      }
    }

    window.handleLogin = handleLogin;
    window.addExpense = addExpense;
    window.nextStage = nextStage;
    window.resetAll = resetAll;
    window.simplify = simplify;

    init();
  </script>
</body>
</html>
